(function(n){"use strict";function f(n,t){return n.substr(n.length-t)}function t(n){return f("00"+(n||0),2)}function u(n){return f("0000"+(n||0),4)}var e=[31,29,31,30,31,30,31,31,30,31,30,31],o={BACKSPACE:8},r=function(t,i){this.$element=n(t);this.options=n.extend({},n.fn.datetextentry.defaults,i);this.add_century=this.options.add_century||this.add_century;this.parse_date=this.options.parse_date||this.parse_date;this.format_date=this.options.format_date||this.format_date;this.human_format_date=this.options.human_format_date||this.human_format_date;this.on_blur=this.options.on_blur;this.on_change=this.options.on_change;this.on_error=this.options.on_error;this.custom_validation=this.options.custom_validation;this.build_ui();this.set_date(this.$element.attr("value"));this.proxy_label_clicks()},i;r.prototype={constructor:r,build_ui:function(){var t=this;this.wrapper=n(this.$element.wrap('<span class="jq-dte" />').parent()[0]);this.inner=n('<span class="jq-dte-inner" />');this.add_entry_fields();this.tooltip=n('<span class="jq-dte-tooltip" />').hide();this.errorbox=n('<span class="jq-dte-errorbox" />').hide();this.inner.on("paste","input",function(n){var i=this;setTimeout(function(){t.after_paste(i,n)},2)});this.wrapper.append(this.inner,this.tooltip,this.errorbox);this.set_field_widths();this.$element.hide()},add_entry_fields:function(){var t=this;t.fields=[];n.each(this.options.field_order.split(""),function(n,i){switch(i){case"D":t.build_field("day",n);break;case"M":t.build_field("month",n);break;case"Y":t.build_field("year",n);break;default:throw new Error("Unexpected field order '"+i+"' expected D, M or Y");}})},build_field:function(t,r){var e=this,u=this.options,f=new i({name:t,dte:e,index:r,hint_text:u.show_hints?u["field_hint_text_"+t]:null,tip_text:u["field_tip_text_"+t]});this.inner.append(f.$input);this["input_"+t]=f;r<2&&this.inner.append(n('<span class="separator" />').text(u.separator));this.fields[r]=f;this[t]=f},set_field_widths:function(){var n=this.options,t=this.$element.width()-2,i=n.field_width_year+n.field_width_sep+n.field_width_month+n.field_width_sep+n.field_width_day;this.input_day.set_width(Math.floor(n.field_width_day*t/i));this.input_month.set_width(Math.floor(n.field_width_month*t/i));this.input_year.set_width(Math.floor(n.field_width_year*t/i))},set_date:function(t){var i=this;t=this.parse_date(t);delete this.day_value;delete this.month_value;delete this.year_value;this.input_day.set(t?t.day:"");this.input_month.set(t?t.month:"");this.input_year.set(t?t.year:"");this.clear_error();this.$element.val(t);t&&n.each(this.fields,function(n,t){i.validate(t)})},proxy_label_clicks:function(){var i=this,t=this.$element.attr("id");t&&n("label[for="+t+"]").click(function(){i.focus()})},clear:function(){this.clear_error("");this.set_date("")},destroy:function(){this.$element.show();this.$element.css("display","");this.wrapper.find("span").remove();this.$element.unwrap();this.$element.removeData("datetextentry");delete this.inner;delete this.wrapper;delete this.$element},after_paste:function(t){var i=n(t).val();this.parse_date(i)&&this.set_date(i)},parse_date:function(n){return this.parse_iso_date(n)},parse_iso_date:function(n){return n&&n.match(/^(\d\d\d\d)-(\d\d)-(\d\d)/)?{day:RegExp.$3,month:RegExp.$2,year:RegExp.$1}:null},get_date:function(){return this.day_value&&this.month_value&&this.year_value?{day:this.day_value,month:this.month_value,year:this.year_value}:null},get_today:function(){var n=new Date;return{day:t(n.getDate()),month:t(n.getMonth()+1),year:u(n.getFullYear())}},format_date:function(n){return this.iso_format_date(n)},iso_format_date:function(n){return[u(n.year),t(n.month),t(n.day)].join("-")},human_format_date:function(n){return[t(n.day),t(n.month),u(n.year)].join("/")},add_century:function(n){return 2e3+n},focus_in:function(){this.wrapper.addClass("focus")},focus_out:function(){if(this.on_blur){var n=this;setTimeout(function(){n.widget_focus_lost()},2)}this.wrapper.removeClass("focus")},widget_focus_lost:function(){this.on_blur&&!this.wrapper.is(".focus")&&this.on_blur()},show_input_tip:function(n){var t=this.options,i,r;t.show_tooltips&&(i=n.left()+t.tooltip_x+"px",r=this.wrapper.height()+t.tooltip_y+"px",this.tooltip.css({position:"absolute",top:r,left:i}).text(n.tip_text).show())},hide_input_tip:function(){this.tooltip.hide()},set_error:function(n){this.error_text=n;this.show_error()},clear_error:function(){delete this.error_text;this.show_error()},set_readonly:function(n){n===undefined&&(n=!0);this.input_day.set_readonly(n);this.input_month.set_readonly(n);this.input_year.set_readonly(n);n?this.wrapper.addClass("readonly"):this.wrapper.removeClass("readonly")},show_error:function(){var n=this.options,t=this.widget_error_text(),i,r;if(this.on_error)this.on_error(t);n.show_errors&&(t===""?(this.errorbox.hide(),this.errorbox.text("")):(i=this.inner.outerWidth()+n.errorbox_x+"px",r=n.errorbox_y+"px",this.errorbox.css({position:"absolute",top:r,left:i}),this.errorbox.text(t),this.errorbox.show()))},widget_error_text:function(){var t="";return n.each(this.fields,function(n,i){i.error_text&&(i.has_focus||t==="")&&(t=i.error_text)}),t===""&&this.error_text&&(t=this.error_text),t},focus:function(){this.fields[0].set_focus(!0)},focus_field_before:function(n){var t=n.index,i;t<1||(this.fields[t].yield_focus(),i=this.fields[t-1],i.get(),i.set_focus(!1))},focus_field_after:function(n){var t=n.index;t>1||(this.fields[t].yield_focus(),this.fields[t+1].set_focus(!0))},validate:function(n){if(this.$element.val(""),n)try{this["validate_"+n.name]();n.clear_error()}catch(t){return n.set_error(t.message||t),!1}if(this.day_value&&this.month_value){this.clear_error();try{if(this.validate_days_in_month(),this.year_value&&this.year_value.length===4){this.validate_complete_date();var r=this.get_date(),i=this.format_date(r);if(this.$element.val(i),this.on_change)this.on_change(i)}}catch(t){return this.set_error(t.message||t),!1}}else this.clear_error();return!0},validate_day:function(){var r=this.options,i=this.input_day,n,t;if(this.day_value=undefined,n=i.get(),n!==""&&(n!=="0"||!i.has_focus)){if(n.match(/\D/))throw new Error(r.E_DAY_NAN);if(t=parseInt(n,10),t<1)throw new Error(r.E_DAY_TOO_SMALL);if(t>31)throw new Error(r.E_DAY_TOO_BIG);n=t<10?"0"+t:""+t;i.has_focus||i.set(n);this.day_value=n}},validate_month:function(){var r=this.options,i=this.input_month,n,t;if(this.month_value=undefined,n=i.get(),n!==""&&(n!=="0"||!i.has_focus)){if(n.match(/\D/))throw new Error(r.E_MONTH_NAN);if(t=parseInt(n,10),t<1)throw new Error(r.E_MONTH_TOO_SMALL);if(t>12)throw new Error(r.E_MONTH_TOO_BIG);n=t<10?"0"+t:""+t;i.has_focus||i.set(n);this.month_value=n}},validate_year:function(){var t=this.options,i=this.input_year,n,r;if(this.year_value=undefined,n=i.get(),n!==""&&(n!=="0"||!i.has_focus)){if(n.match(/\D/))throw new Error(t.E_YEAR_NAN);if(i.has_focus){if(n.length>4)throw new Error(t.E_YEAR_LENGTH);}else if(n.length===2&&(n=""+this.add_century(parseInt(n,10)),this.input_year.set(n)),n.length!==4)throw new Error(t.E_YEAR_LENGTH);if(n.length===4){if(r=parseInt(n,10),t.min_year&&r<t.min_year)throw new Error(t.E_YEAR_TOO_SMALL.replace(/%y/,t.min_year));if(t.max_year&&r>t.max_year)throw new Error(t.E_YEAR_TOO_BIG.replace(/%y/,t.max_year));}this.year_value=n}},validate_days_in_month:function(){var u=this.options,f=parseInt(this.day_value,10),i=parseInt(this.month_value,10),t=parseInt(this.year_value,10),r,n;if(!(f<1)&&!(i<1)&&(r=e[i-1],n=u.E_BAD_DAY_FOR_MONTH,i===2&&(""+t).length===4?(r=t%4?28:t%100?29:t%400?28:29,n=n.replace(/%y/,t)):n=n.replace(/ *%y/,""),f>r))throw new Error(n.replace(/%d/,r).replace(/%m/,u.month_name[i-1]));},validate_complete_date:function(){var i=this.options,r=this.get_date(),f=this.iso_format_date(r),u=null,t=i.max_date,n;if(typeof t=="function"&&(t=t.call(this)),typeof t=="string"&&(t=this.parse_date(t)),t&&f>this.iso_format_date(t)&&(u=i.max_date_message?i.max_date_message:i.E_MAX_DATE,u))throw new Error(u.replace(/%DATE/,this.human_format_date(t)));if(n=i.min_date,typeof n=="function"&&(n=n.call(this)),typeof n=="string"&&(n=this.parse_date(n)),n&&f<this.iso_format_date(n)&&(u=i.min_date_message?i.min_date_message:i.E_MIN_DATE,u))throw new Error(u.replace(/%DATE/,this.human_format_date(n)));this.custom_validation&&(r.date=new Date(parseInt(r.year,10),parseInt(r.month,10)-1,parseInt(r.day,10)),this.custom_validation(r))}};i=function(t){var i=this;this.dte=t.dte;this.name=t.name;this.index=t.index;this.hint_text=t.hint_text;this.tip_text=t.tip_text;this.has_focus=!1;this.empty=!0;this.$input=n('<input type="text" value="" />').addClass("jq-dte-"+this.name).attr("aria-label",this.tip_text+" ("+this.hint_text+")").focus(n.proxy(i,"focus")).blur(n.proxy(i,"blur")).keydown(function(n){setTimeout(function(){i.keydown(n)},2)}).keyup(function(n){setTimeout(function(){i.keyup(n)},2)})};i.prototype={constructor:i,set:function(n){return this.$input.val(n).removeClass("hint"),this.has_focus||this.show_hint(),this.empty=n==="",this.clear_error(),this},get:function(){var n=this.$input.val();return n===this.hint_text?"":n},left:function(){return this.$input.position().left},set_width:function(n){return this.$input.width(n),this},show_hint:function(){return this.get()===""&&typeof this.hint_text=="string"&&this.$input.val(this.hint_text).addClass("hint"),this},yield_focus:function(){this.$input.blur()},set_focus:function(n){var t=this.$input;return t.focus(),n?t.select():t.val(t.val()),this},set_error:function(n){this.error_text=n;this.$input.addClass("error");this.dte.show_error()},clear_error:function(){delete this.error_text;this.$input.removeClass("error")},set_readonly:function(n){this.$input.prop("readonly",n)},focus:function(){(this.key_is_down=!1,this.$input.prop("readonly"))||(this.has_focus=!0,this.dte.focus_in(),this.$input.hasClass("hint")&&this.$input.val("").removeClass("hint"),this.dte.show_input_tip(this),this.dte.show_error())},blur:function(){this.has_focus=!1;this.dte.focus_out();this.dte.hide_input_tip();this.show_hint();this.dte.validate(this)},keydown:function(){this.key_is_down=!0},keyup:function(n){var i,t,r;if(this.key_is_down){if(i=n.which,i===o.BACKSPACE&&this.empty)return this.dte.focus_field_before(this);t=this.get();this.empty=t==="";t.match(/[/\\. -]/)&&(t=t.replace(/[/\\. -]/,""),this.set(t),!this.empty&&this.index<2&&this.dte.focus_field_after(this));this.dte.validate(this)&&(r=this.name==="year"?4:2,this.is_digit_key(n)&&t.length===r&&this.dte.focus_field_after(this))}},is_digit_key:function(n){var t=n.which;return t>=48&&t<=57||t>=96&&t<=105}};n.fn.datetextentry=function(t){var i=Array.prototype.slice.call(arguments,1);return this.each(function(){var f=n(this),u=f.data("datetextentry");if(u||(u=new r(this,t),f.data("datetextentry",u)),typeof t=="string"){if(typeof u[t]!="function")throw new Error("jquery.datetextentry has no '"+t+"' method");u[t].apply(u,i)}})};n.fn.datetextentry.defaults={field_order:"DMY",separator:"/",show_tooltips:!0,show_hints:!0,show_errors:!0,field_width_day:40,field_width_month:40,field_width_year:60,field_width_sep:4,errorbox_x:8,errorbox_y:3,tooltip_x:0,tooltip_y:6,field_tip_text_day:"Day",field_tip_text_month:"Month",field_tip_text_year:"Year",field_hint_text_day:"DD",field_hint_text_month:"MM",field_hint_text_year:"YYYY",E_DAY_NAN:"Day must be a number",E_DAY_TOO_BIG:"Day must be 1-31",E_DAY_TOO_SMALL:"Day must be 1-31",E_BAD_DAY_FOR_MONTH:"Only %d days in %m %y",E_MONTH_NAN:"Month must be a number",E_MONTH_TOO_BIG:"Month must be 1-12",E_MONTH_TOO_SMALL:"Month must be 1-12",E_YEAR_NAN:"Year must be a number",E_YEAR_LENGTH:"Year must be 4 digits",E_YEAR_TOO_SMALL:"Year must not be before %y",E_YEAR_TOO_BIG:"Year must not be after %y",E_MIN_DATE:"Date must not be earlier than %DATE",E_MAX_DATE:"Date must not be later than %DATE",month_name:["January","February","March","April","May","June","July","August","September","October","November","December"]}})(jQuery);